# MCP Server v1.0.0 开发环境 Dockerfile
# 开发环境配置，支持热重载和调试

FROM node:22-slim

# 设置环境变量
ENV NODE_ENV=development \
    PNPM_HOME=/usr/local/share/pnpm \
    PATH=/usr/local/share/pnpm:$PATH \
    DEBIAN_FRONTEND=noninteractive

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    git \
    python3 \
    python3-pip \
    python3-venv \
    ca-certificates \
    vim \
    htop \
    procps \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && update-ca-certificates

# 安装 pnpm 和 uv
RUN npm install -g pnpm@latest
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 设置环境变量
ARG HTTP_PROXY=""
ARG HTTPS_PROXY=""
ARG NODE_ENV=development
ARG DEBUG=false

ENV HTTP_PROXY=$HTTP_PROXY \
    HTTPS_PROXY=$HTTPS_PROXY \
    NODE_ENV=$NODE_ENV \
    DEBUG=$DEBUG \
    PNPM_HOME=/usr/local/share/pnpm \
    PATH=/usr/local/share/pnpm:$PATH \
    NODE_OPTIONS="--inspect=0.0.0.0:9229 --max-old-space-size=2048"

# 创建 pnpm 目录并安装全局 MCP 服务器
RUN mkdir -p $PNPM_HOME && \
    pnpm add -g \
    @amap/amap-maps-mcp-server \
    @playwright/mcp@latest \
    tavily-mcp@latest \
    @modelcontextprotocol/server-github \
    @modelcontextprotocol/server-slack

# 安装 Python MCP 工具
RUN uv tool install mcp-server-fetch

# 创建开发用户
RUN groupadd -r mcpserver && \
    useradd -r -g mcpserver -s /bin/bash -d /app mcpserver

# 设置工作目录
WORKDIR /app

# 复制 package 配置文件
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY frontend/package.json ./frontend/

# 设置 pnpm 配置
RUN pnpm config set store-dir /app/.pnpm-store

# 安装依赖
RUN pnpm install

# 复制启动脚本
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# 创建开发目录
RUN mkdir -p /app/logs /app/tmp /app/cache /app/.vscode && \
    chown -R mcpserver:mcpserver /app

# 切换到开发用户
USER mcpserver

# 暴露端口
EXPOSE 3000 5173 9229

# 设置入口点
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["sh", "-c", "pnpm frontend:dev & pnpm backend:dev & wait"]

# 元数据标签
LABEL maintainer="MCP Server Team" \
      version="1.0.0" \
      description="MCP Server Development Environment" \
      org.opencontainers.image.title="MCP Server Dev" \
      org.opencontainers.image.description="MCP Server Development Environment" \
      org.opencontainers.image.version="1.0.0" \
      org.opencontainers.image.vendor="MCP Server Project"
